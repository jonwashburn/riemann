name: Verify Proof

on:
  push:
  pull_request:

jobs:
  verify:
    name: Verify on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    defaults:
      run:
        shell: bash
        working-directory: riemann/no-zeros
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache elan
        uses: actions/cache@v4
        with:
          path: ~/.elan
          key: ${{ runner.os }}-elan-4.12.0

      - name: Set up elan (Lean toolchain)
        uses: leanprover/elan-action@v1
        with:
          # Uses the lean-toolchain file (v4.12.0) in the repository
          override-toolchain: false

      - name: Show Lean version
        run: |
          lean --version || true
          lake --version || true

      - name: Cache lake
        uses: actions/cache@v4
        with:
          path: |
            riemann/no-zeros/.lake
            riemann/no-zeros/lake-manifest.json
          key: ${{ runner.os }}-lake-${{ hashFiles('riemann/no-zeros/lakefile.lean') }}

      - name: Build export target
        run: |
          lake build rh_export

      - name: Verify (human-readable)
        run: |
          bash ./verify_proof.sh

      - name: Verify (JSON)
        run: |
          bash ./verify_proof.sh --json > verify.json

      - name: Upload verification artifacts
        uses: actions/upload-artifact@v4
        with:
          name: verify-${{ matrix.os }}
          path: |
            riemann/no-zeros/verify.json
            riemann/no-zeros/PROOF_CERTIFICATE.md


